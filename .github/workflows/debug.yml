name: Debug AWX Token

on:
  workflow_dispatch: # Allows you to run this manually

jobs:
  test-token-and-resolution:
    runs-on: self-hosted # CRITICAL: Must run on your runner
    
    steps:
      - name: Test AWX Token
        env:
          HOST_TO_TEST: ${{ vars.AWX_HOST }}
          ID_TO_TEST: ${{ vars.AWX_JOB_TEMPLATE_ID }}
          TEST_TOKEN: ${{ secrets.AWX_TOKEN }} 
        run: |
          # Enable verbose command tracing
          set -x
          
          echo "--- DEBUGGING GITHUB ACTIONS VARIABLES ---"
          echo "Value of 'vars.AWX_HOST': [$HOST_TO_TEST]"
          echo "Value of 'vars.AWX_JOB_TEMPLATE_ID': [$ID_TO_TEST]"
          echo "----------------------------------------------"
          
          if [ -z "$HOST_TO_TEST" ]; then
            echo "Error: 'AWX_HOST' repository variable is EMPTY."
            exit 1
          fi

          if [ -z "$TEST_TOKEN" ]; then
            echo "Error: 'AWX_TOKEN' repository secret is EMPTY."
            exit 1
          fi
          
          echo "--- CHECKING CURL INSTALLATION ---"
          curl --version
          echo "--------------------------------"

          echo ""
          echo "Success: Variables and Secret are loaded."
          echo "Attempting to authenticate to AWX at: http://$HOST_TO_TEST"
          echo ""
          
          # This is the test. It uses the secret.
          # We use curl -i to show headers, and -sS to hide progress but show errors.
          curl -i -sS -H "Authorization: Bearer $TEST_TOKEN" "http://$HOST_TO_TEST/api/v2/job_templates/"
          
          # We'll check the exit code manually for debugging
          CURL_EXIT_CODE=$?
          echo ""
          echo "curl command finished with exit code: $CURL_EXIT_CODE"
          
          if [ $CURL_EXIT_CODE -eq 0 ]; then
            echo "Success: curl command ran (exit code 0). Check the HTTP status (200 or 401) above."
          elif [ $CURL_EXIT_CODE -eq 2 ]; then
            echo "Error: curl failed with exit code 2 (CURLE_FAILED_INIT)."
            echo "This is a low-level curl initialization error."
            echo "Even after unsetting proxies, this failed, suggesting a deeper runner environment problem."
          else
            echo "Error: curl failed with a non-zero exit code: $CURL_EXIT_CODE"
          fi
          
          exit $CURL_EXIT_CODE
